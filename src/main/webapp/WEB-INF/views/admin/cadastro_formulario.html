<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Novo Formulário</title>
    <style>
        /* Estilo Limpo e Profissional */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        /* Cabeçalho */
        header { border-bottom: 2px solid #007bff; padding-bottom: 15px; margin-bottom: 25px; }
        h2 { margin: 0; color: #333; }

        /* Grupos de Inputs */
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #495057; }
        input[type="text"], select { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }

        /* Card da Questão */
        .questao-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-left: 5px solid #007bff; /* Destaque visual */
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 4px;
            position: relative;
            animation: fadeIn 0.3s;
        }

        /* Botão de Remover (X) */
        .btn-remove { position: absolute; top: 10px; right: 10px; color: #dc3545; background: none; border: none; font-weight: bold; cursor: pointer; font-size: 1.1em; }
        .btn-remove:hover { color: #a71d2a; }

        /* Área de Alternativas */
        .area-alternativas { background: #e9ecef; padding: 10px; margin-top: 10px; border-radius: 4px; display: none; }
        .hint { font-size: 0.85em; color: #6c757d; margin-bottom: 5px; display: block; }

        /* Checkboxes Customizados */
        .chk-group { display: flex; align-items: center; gap: 8px; margin-top: 10px; background: #e2e6ea; padding: 8px 12px; border-radius: 20px; width: fit-content; }
        .chk-group input { width: 16px; height: 16px; margin: 0; }

        /* Botões */
        .btn { padding: 12px 20px; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; transition: background 0.2s; }
        .btn-add { background-color: #17a2b8; color: white; margin-bottom: 20px; }
        .btn-add:hover { background-color: #138496; }
        .btn-save { background-color: #28a745; color: white; }
        .btn-save:hover { background-color: #218838; }
        .btn-back { display: inline-block; margin-bottom: 15px; color: #6c757d; text-decoration: none; font-weight: 600; }
        .btn-back:hover { text-decoration: underline; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <a href="processos" class="btn-back">← Voltar para Lista de Processos</a>

    <header>
        <h2>Criar Formulário de Avaliação</h2>
        <small style="color: #666;">Defina as perguntas e configurações iniciais.</small>
    </header>

    <div class="form-group">
        <label>Título do Formulário</label>
        <input type="text" id="titulo" placeholder="Ex: Avaliação Institucional 2024/2" required>
    </div>

    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 1;">
            <label>Público Alvo (Perfil)</label>
            <select id="perfilDestino">
                <option value="4">Aluno (Avalia Professores/Turmas)</option>
                <option value="2">Professor (Autoavaliação)</option>
            </select>
        </div>
        <div style="flex: 1; display: flex; align-items: flex-end;">
            <label class="chk-group">
                <input type="checkbox" id="anonimo">
                Respostas Anônimas
            </label>
        </div>
    </div>

    <hr style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">

    <h3>Questões</h3>
    <div id="lista-questoes">
    </div>

    <button type="button" class="btn btn-add" onclick="novaQuestao()">+ Adicionar Questão</button>
    <button type="button" class="btn btn-save" onclick="salvarFormulario()">Salvar Formulário</button>
</div>

<script>
    // Recupera ID do Processo da URL
    const params = new URLSearchParams(window.location.search);
    const processoId = params.get('processoId');

    // Validação inicial
    if (!processoId) {
        alert("Processo Avaliativo não informado. Retornando...");
        window.location.href = 'processos';
    }

    // Função para adicionar HTML de uma nova questão
    function novaQuestao() {
        const container = document.getElementById('lista-questoes');
        const id = Date.now(); // ID temporário visual

        const html = `
            <div class="questao-card" id="q-${id}">
                <button class="btn-remove" onclick="removerQuestao('${id}')" title="Remover questão">×</button>

                <div class="form-group">
                    <label>Enunciado da Pergunta:</label>
                    <input type="text" class="q-enunciado" placeholder="Digite a pergunta aqui..." required>
                </div>

                <div style="display: flex; gap: 15px;">
                    <div style="flex: 2;">
                        <label>Tipo de Resposta:</label>
                        <select class="q-tipo" onchange="alternarOpcoes('${id}', this.value)">
                            <option value="OBJETIVA">Objetiva (Escolha Única)</option>
                            <option value="MULTIPLA_ESCOLHA">Múltipla Escolha (Várias)</option>
                            <option value="ABERTA">Texto Livre (Aberta)</option>
                        </select>
                    </div>
                    <div style="flex: 1; display: flex; align-items: flex-end;">
                        <label class="chk-group" style="margin-top:0; width:100%;">
                            <input type="checkbox" class="q-obrigatoria"> Obrigatória
                        </label>
                    </div>
                </div>

                <div id="opcoes-${id}" class="area-alternativas" style="display: block;">
                    <span class="hint">Digite as opções separadas por vírgula:</span>
                    <input type="text" class="q-alternativas" placeholder="Ex: Excelente, Bom, Regular, Ruim">
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', html);
    }

    // Controla visibilidade das alternativas (RF09)
    function alternarOpcoes(id, tipo) {
        const div = document.getElementById(`opcoes-${id}`);
        if (tipo === 'ABERTA') {
            div.style.display = 'none';
        } else {
            div.style.display = 'block';
            // Foca no input se reaparecer
            div.querySelector('input').focus();
        }
    }

    function removerQuestao(id) {
        const card = document.getElementById(`q-${id}`);
        card.style.opacity = '0';
        setTimeout(() => card.remove(), 200); // Efeito visual rápido
    }

    // Envio dos dados para a API (Servlet)
    async function salvarFormulario() {
        const btn = document.querySelector('.btn-save');
        const titulo = document.getElementById('titulo').value;

        if (!titulo.trim()) {
            alert("Por favor, dê um título ao formulário.");
            return;
        }

        const questoesDOM = document.querySelectorAll('.questao-card');
        if (questoesDOM.length === 0) {
            alert("Adicione pelo menos uma questão.");
            return;
        }

        const questoesDTO = [];

        // Varre os cards HTML para montar o JSON
        questoesDOM.forEach(card => {
            const tipo = card.querySelector('.q-tipo').value;
            const textoAlts = card.querySelector('.q-alternativas').value;

            let listaAlternativas = [];
            // Processa alternativas apenas se não for questão aberta (RF08)
            if (tipo !== 'ABERTA' && textoAlts.trim().length > 0) {
                listaAlternativas = textoAlts.split(',').map(t => ({
                    texto: t.trim(),
                    peso: 1
                }));
            }

            questoesDTO.push({
                enunciado: card.querySelector('.q-enunciado').value,
                tipo: tipo,
                obrigatoria: card.querySelector('.q-obrigatoria').checked,
                alternativas: listaAlternativas
            });
        });

        const payload = {
            titulo: titulo,
            anonimo: document.getElementById('anonimo').checked,
            processoId: parseInt(processoId),
            perfilDestinoId: parseInt(document.getElementById('perfilDestino').value),
            questoes: questoesDTO
        };

        // Envio
        try {
            btn.disabled = true;
            btn.innerText = "Salvando...";

            const response = await fetch('../api/admin/formularios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                alert("Formulário criado com sucesso!");
                window.location.href = 'processos'; // Volta para a listagem
            } else {
                const erro = await response.json();
                alert("Erro ao salvar: " + (erro.erro || "Erro desconhecido"));
                btn.disabled = false;
                btn.innerText = "Salvar Formulário";
            }
        } catch (e) {
            console.error(e);
            alert("Erro de conexão com o servidor.");
            btn.disabled = false;
            btn.innerText = "Salvar Formulário";
        }
    }
</script>

</body>
</html>